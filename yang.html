<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¾Šäº†ä¸ªç¾Š - åœ°ç‹±éš¾åº¦ç‰ˆ</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #c4e69d; /* ç»å…¸çš„è‰åœ°ç»¿èƒŒæ™¯ */
            font-family: "Microsoft YaHei", sans-serif;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        /* æ¸¸æˆæ ‡é¢˜ */
        h1 {
            text-align: center;
            color: #fff;
            text-shadow: 2px 2px 0 #5d8a28;
            margin-top: 20px;
            pointer-events: none;
        }

        /* æ¸¸æˆä¸»åŒºåŸŸ */
        #game-board {
            position: relative;
            width: 100%;
            height: 60vh;
            margin-top: 20px;
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            width: 48px;
            height: 56px;
            background-color: #fff;
            border: 2px solid #333;
            border-radius: 6px;
            position: absolute;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            box-shadow: 0 4px 0 #ccc; /* ä¼ª3Dæ•ˆæœ */
            cursor: pointer;
            transition: top 0.2s, left 0.2s, transform 0.1s;
            z-index: 0;
        }

        /* è¢«é®æŒ¡çš„å¡ç‰‡å˜æš— */
        .card.covered {
            filter: brightness(40%);
            pointer-events: none; /* ç¦æ­¢ç‚¹å‡» */
            cursor: default;
        }

        /* é€‰ä¸­æ—¶çš„ç‚¹å‡»æ•ˆæœ */
        .card:active {
            transform: scale(0.95);
        }

        /* åº•éƒ¨æ§½ä½å®¹å™¨ */
        #dock-container {
            position: fixed;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 370px; /* 7 * (48+4) + padding */
            height: 70px;
            background-color: #8b5a2b; /* æœ¨çº¹è‰² */
            border: 4px solid #5d3a1a;
            border-radius: 10px;
            display: flex;
            align-items: center;
            padding-left: 5px;
            box-sizing: border-box;
        }

        /* æ§½ä½é‡Œçš„å¡ç‰‡æ ·å¼é‡ç½® */
        .card.in-dock {
            position: static; /* å–æ¶ˆç»å¯¹å®šä½ */
            margin-right: 4px;
            box-shadow: none;
            border-bottom: 2px solid #333;
            transform: none !important;
            filter: brightness(100%) !important;
            pointer-events: none;
        }

        /* ç»“ç®—å¼¹çª— */
        #modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        #modal h2 {
            color: #fff;
            font-size: 40px;
            margin-bottom: 20px;
        }
        #modal button {
            padding: 15px 40px;
            font-size: 24px;
            background: #fdd835;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 0 #fbc02d;
        }
        #modal button:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        /* å…³å¡æç¤º */
        #level-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
        }

    </style>
</head>
<body>

    <div id="level-indicator">å½“å‰å…³å¡ï¼šç¬¬ 1 å…³</div>
    <h1>ğŸ‘ ç¾Šäº†ä¸ªç¾Š ğŸ‘</h1>

    <!-- æ¸¸æˆæ£‹ç›˜åŒº -->
    <div id="game-board"></div>

    <!-- åº•éƒ¨æ§½ä½ -->
    <div id="dock-container"></div>

    <!-- å¼¹çª— -->
    <div id="modal">
        <h2 id="result-text">å¤±è´¥ï¼</h2>
        <button onclick="restartGame()">é‡æ–°æŒ‘æˆ˜</button>
    </div>

    <script>
        // === 1. æ¸¸æˆé…ç½® ===
        const GAME_BOARD = document.getElementById('game-board');
        const DOCK = document.getElementById('dock-container');
        const MODAL = document.getElementById('modal');
        const RESULT_TEXT = document.getElementById('result-text');
        const LEVEL_TEXT = document.getElementById('level-indicator');

        // å›¾æ¡ˆç´ æ (Emoji)
        const ICONS = ['ğŸ¥•', 'ğŸ¥¬', 'ğŸ”¥', 'ğŸ§¤', 'ğŸ§¶', 'ğŸŒ²', 'ğŸ””', 'ğŸŒ½', 'ğŸ¥›', 'ğŸ”¨', 'âœ‚ï¸', 'ğŸ—'];
        
        let currentLevel = 1;
        let dockCards = []; // æ§½ä½é‡Œçš„ç‰Œ
        let allCards = [];  // åœºä¸Šæ‰€æœ‰çš„ç‰Œ DOM å¯¹è±¡

        // === 2. å…³å¡è®¾è®¡ ===

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame(level) {
            currentLevel = level;
            LEVEL_TEXT.innerText = `å½“å‰å…³å¡ï¼šç¬¬ ${level} å…³`;
            
            // æ¸…ç†æ—§æ•°æ®
            GAME_BOARD.innerHTML = '';
            DOCK.innerHTML = '';
            dockCards = [];
            allCards = [];
            MODAL.style.display = 'none';

            if (level === 1) {
                setupLevel1();
            } else {
                setupLevel2();
            }
            
            updateCardStatus(); // åˆå§‹è®¡ç®—é®æŒ¡
        }

        // ç¬¬ä¸€å…³ï¼šæå…¶ç®€å• (åªæœ‰3ç§å›¾æ¡ˆï¼Œå°‘é‡ç‰Œï¼Œå¹³é“º)
        function setupLevel1() {
            const types = ICONS.slice(0, 3); // åªç”¨å‰3ç§
            let cardData = [];
            // æ¯ç§3å¼ ï¼Œä¿è¯èƒ½æ¶ˆå®Œ
            types.forEach(icon => {
                for(let i=0; i<3; i++) cardData.push(icon);
            });
            // å†åŠ ä¸€ç»„æ‰“ä¹±
            types.forEach(icon => {
                for(let i=0; i<3; i++) cardData.push(icon);
            });

            // ç®€å•çš„ç½‘æ ¼å¸ƒå±€
            const centerX = window.innerWidth / 2 - 24;
            const startY = 100;
            
            cardData.forEach((icon, index) => {
                let row = Math.floor(index / 6);
                let col = index % 6;
                let x = centerX - 150 + col * 55;
                let y = startY + row * 60;
                createCard(icon, x, y, 0);
            });
        }

        // ç¬¬äºŒå…³ï¼šåœ°ç‹±éš¾åº¦ (å¤§é‡ç‰Œï¼Œéšæœºå †å )
        function setupLevel2() {
            // 1. ç”Ÿæˆå¡æ±  (å¿…é¡»æ˜¯3çš„å€æ•°)
            let cardData = [];
            const totalCards = 210; // æ•°é‡è¶Šå¤šè¶Šéš¾
            
            // éšæœºç”Ÿæˆä¸‰ä¸‰æˆå¯¹çš„ç‰Œ
            for (let i = 0; i < totalCards / 3; i++) {
                // éšæœºé€‰ä¸€ä¸ªå›¾æ¡ˆ
                const randomIcon = ICONS[Math.floor(Math.random() * ICONS.length)];
                cardData.push(randomIcon, randomIcon, randomIcon);
            }
            
            // æ‰“ä¹±æ•°ç»„ (æ´—ç‰Œ)
            cardData.sort(() => Math.random() - 0.5);

            // 2. å®šä¹‰å †å åŒºåŸŸä¸­å¿ƒ
            const cx = window.innerWidth / 2 - 24;
            const cy = 150;

            // 3. ç”Ÿæˆå¡ç‰‡ DOM
            cardData.forEach((icon, index) => {
                // æ ¸å¿ƒç®—æ³•ï¼šå±‚å±‚å †å 
                // æ¨¡æ‹Ÿé‡‘å­—å¡”æˆ–éšæœºæ•£è½
                
                // éšæœºåç§»é‡ï¼Œåˆ¶é€ æ‚ä¹±æ„Ÿï¼Œä½†å¤§éƒ¨åˆ†é›†ä¸­åœ¨ä¸­é—´
                // æ¯ä¸€å±‚çš„èŒƒå›´é€æ¸å˜å¤§æˆ–å˜å°
                let layer = Math.floor(index / 10); // ç®€å•çš„åˆ†å±‚é€»è¾‘
                
                // x, y åæ ‡ï¼šåœ¨ä¸€ä¸ªèŒƒå›´å†…éšæœºï¼Œä¸”ä¸€å®šè¦æŒ‰ç½‘æ ¼å¯¹é½(æ¯æ­¥24pxåŠä¸ªèº«ä½)ï¼Œåˆ¶é€ äº’ç›¸å‹ä½ä¸€åŠçš„æ•ˆæœ
                // range éšå±‚æ•°å˜åŒ–ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯éšæœºæ€§
                let range = 120; 
                let randomX = (Math.random() - 0.5) * 2 * range;
                let randomY = (Math.random() - 0.5) * 2 * range;

                // å¯¹é½ç½‘æ ¼ (Step = å¡ç‰‡å®½çš„ä¸€åŠ 24)
                let finalX = cx + Math.round(randomX / 24) * 24;
                let finalY = cy + Math.round(randomY / 24) * 24;

                // Z-index éš index å¢åŠ ï¼Œä¿è¯åç”Ÿæˆçš„å‹åœ¨ä¸Šé¢
                createCard(icon, finalX, finalY, index);
            });
        }

        // åˆ›å»ºå•å¼ å¡ç‰‡ DOM
        function createCard(icon, x, y, zIndex) {
            const card = document.createElement('div');
            card.classList.add('card');
            card.innerText = icon;
            card.style.left = x + 'px';
            card.style.top = y + 'px';
            card.style.zIndex = zIndex;
            
            // æ•°æ®ç»‘å®š
            card.dataset.icon = icon;
            card.dataset.id = Date.now() + Math.random(); // å”¯ä¸€ID

            // ç‚¹å‡»äº‹ä»¶
            card.addEventListener('click', function() {
                // å¦‚æœè¢«é®æŒ¡ï¼Œä¸èƒ½ç‚¹
                if (this.classList.contains('covered')) return;
                
                moveToDock(this);
            });

            GAME_BOARD.appendChild(card);
            allCards.push(card);
        }

        // === 3. æ ¸å¿ƒé€»è¾‘ï¼šé®æŒ¡åˆ¤æ–­ ===
        function updateCardStatus() {
            // æš´åŠ›æ£€æµ‹ï¼šéå†æ¯å¼ ç‰Œï¼Œçœ‹å®ƒæ˜¯å¦è¢«â€œZ-indexæ¯”å®ƒå¤§â€ä¸”â€œä½ç½®é‡å â€çš„ç‰Œé®æŒ¡
            allCards.forEach(cardA => {
                // å¦‚æœå·²ç»åœ¨æ§½ä½é‡Œï¼Œä¸ç”¨ç®¡
                if (cardA.classList.contains('in-dock')) return;

                let isCovered = false;
                const rectA = cardA.getBoundingClientRect();

                for (let cardB of allCards) {
                    if (cardA === cardB) continue;
                    if (cardB.classList.contains('in-dock')) continue; // æ§½é‡Œçš„ç‰Œä¸é®æŒ¡åœºä¸Šçš„
                    
                    // åªæœ‰ Z-index æ›´å¤§çš„ç‰Œæ‰èƒ½é®æŒ¡ A
                    // è½¬æ¢ zIndex ä¸ºæ•°å­—æ¯”è¾ƒ
                    if (parseInt(cardB.style.zIndex) <= parseInt(cardA.style.zIndex)) continue;

                    const rectB = cardB.getBoundingClientRect();

                    // åˆ¤æ–­çŸ©å½¢é‡å  (ç®€å•çš„ AABB ç¢°æ’)
                    // ç¨å¾®ç¼©å°ä¸€ç‚¹ç¢°æ’åˆ¤å®šèŒƒå›´(margin)ï¼Œè®©è¾¹ç¼˜éœ²å‡ºæ¥ä¸€ç‚¹ç‚¹ä¹Ÿèƒ½ç‚¹ï¼Œæ›´ç¬¦åˆæ‰‹æ„Ÿ
                    const margin = 2; 
                    const intersect = !(
                        rectA.right - margin < rectB.left + margin || 
                        rectA.left + margin > rectB.right - margin || 
                        rectA.bottom - margin < rectB.top + margin || 
                        rectA.top + margin > rectB.bottom - margin
                    );

                    if (intersect) {
                        isCovered = true;
                        break; // åªè¦è¢«ä¸€å¼ ç‰ŒæŒ¡ä½ï¼Œå°±åºŸäº†
                    }
                }

                if (isCovered) {
                    cardA.classList.add('covered');
                } else {
                    cardA.classList.remove('covered');
                }
            });
        }

        // === 4. æ ¸å¿ƒé€»è¾‘ï¼šç§»åŠ¨åˆ°æ§½ä½ä¸æ¶ˆé™¤ ===
        function moveToDock(card) {
            // 1. ä» board æ•°ç»„é€»è¾‘ä¸­ç§»é™¤ (è§†è§‰ä¸Šå·²ç»åœ¨ dock é‡Œäº†ï¼Œä¸éœ€è¦ä¸“é—¨åˆ æ•°ç»„ï¼Œç”¨ class åŒºåˆ†å³å¯)
            card.classList.add('in-dock');
            card.classList.remove('covered'); // è¿›æ§½ä½è‚¯å®šäº®
            card.style.zIndex = 9999; // ä¿è¯åœ¨æœ€ä¸Šå±‚åŠ¨ç”»

            // 2. æ·»åŠ åˆ°é€»è¾‘æ§½ä½æ•°ç»„
            dockCards.push(card);
            
            // 3. æ¸²æŸ“æ§½ä½ (å°† DOM ç§»åŠ¨åˆ° dock å®¹å™¨)
            DOCK.appendChild(card);
            
            // 4. æ£€æŸ¥æ¶ˆé™¤
            checkMatch();

            // 5. æ£€æŸ¥å¤±è´¥
            if (dockCards.length >= 7) {
                gameOver(false);
            }

            // 6. æ›´æ–°åœºä¸Šå‰©ä½™ç‰Œçš„é®æŒ¡çŠ¶æ€
            updateCardStatus();
        }

        function checkMatch() {
            // ç»Ÿè®¡æ¯ä¸ªå›¾æ¡ˆçš„æ•°é‡
            let counts = {};
            dockCards.forEach(c => {
                let icon = c.dataset.icon;
                counts[icon] = (counts[icon] || 0) + 1;
            });

            // æ‰¾å‡ºæ•°é‡è¾¾åˆ°3çš„å›¾æ¡ˆ
            let matchIcon = null;
            for (let icon in counts) {
                if (counts[icon] >= 3) {
                    matchIcon = icon;
                    break;
                }
            }

            if (matchIcon) {
                // æ‰§è¡Œæ¶ˆé™¤
                // 1. æ‰¾å‡ºå¯¹åº”çš„ DOM å…ƒç´ 
                const toRemove = dockCards.filter(c => c.dataset.icon === matchIcon).slice(0, 3);
                
                // 2. ä» DOM ç§»é™¤
                toRemove.forEach(c => {
                    c.remove(); // å½»åº•åˆ é™¤
                    // ä» allCards ç§»é™¤ï¼Œä¼˜åŒ–æ€§èƒ½
                    allCards = allCards.filter(x => x !== c);
                });

                // 3. ä» dockCards æ•°ç»„ç§»é™¤
                dockCards = dockCards.filter(c => !toRemove.includes(c));
                
                // 4. æ£€æŸ¥æ˜¯å¦é€šå…³
                // å¦‚æœ board ä¸Šæ²¡ç‰Œäº†ï¼Œä¸” dock é‡Œä¹Ÿæ²¡ç‰Œäº† (å®é™…ä¸Šåªéœ€è¦åˆ¤æ–­ allCards æ˜¯å¦ä¸ºç©º)
                // æ³¨æ„ï¼šallCards åŒ…å«äº† dock é‡Œçš„ç‰Œï¼Œæ‰€ä»¥åªè¦ allCards ç©ºäº†å°±æ˜¯èµ¢äº†
                if (allCards.length === 0) {
                    setTimeout(() => gameOver(true), 300);
                }
            }
        }

        // æ¸¸æˆç»“æŸ
        function gameOver(win) {
            MODAL.style.display = 'flex';
            if (win) {
                if (currentLevel === 1) {
                    RESULT_TEXT.innerText = "æ­å–œé€šè¿‡ç¬¬ä¸€å…³ï¼\nçœŸæ­£çš„æŒ‘æˆ˜å¼€å§‹äº†...";
                    RESULT_TEXT.style.color = "#81c784";
                    document.querySelector('#modal button').innerText = "è¿›å…¥ç¬¬äºŒå…³";
                    document.querySelector('#modal button').onclick = function() {
                        initGame(2);
                    };
                } else {
                    RESULT_TEXT.innerText = "ç«Ÿç„¶é€šå…³äº†ï¼Ÿï¼\nä½ æ˜¯ä¸‡ä¸­æ— ä¸€çš„å¤©æ‰ï¼";
                    RESULT_TEXT.style.color = "#ffd700";
                    document.querySelector('#modal button').innerText = "å†æ¥ä¸€å±€";
                    document.querySelector('#modal button').onclick = restartGame;
                }
            } else {
                RESULT_TEXT.innerText = "ä½ ä¹Ÿæ˜¯é‚£99.9%çš„ç¾Šç¾¤...";
                RESULT_TEXT.style.color = "#e57373";
                document.querySelector('#modal button').innerText = "ä¸æœï¼Œé‡æ¥ï¼";
                document.querySelector('#modal button').onclick = restartGame;
            }
        }

        function restartGame() {
            // å¦‚æœæ˜¯åœ¨ç¬¬äºŒå…³è¾“çš„ï¼Œé‡å¼€ç›´æ¥æ‰“ç¬¬äºŒå…³ï¼Œçœå¾—å†æ‰“ç¬¬ä¸€å…³
            initGame(currentLevel); 
        }

        // å¯åŠ¨
        initGame(1);

    </script>
</body>
</html>